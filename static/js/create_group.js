// Generated by CoffeeScript 1.6.3
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  $(function() {
    var add_to_selected_users, cache, create_suggestion_box, dom_complete_box, dom_selected_list, selected_users, update_user_selection;
    dom_complete_box = $("#username_input");
    dom_selected_list = $('#selected_users');
    selected_users = [];
    add_to_selected_users = function(username) {
      if (__indexOf.call(selected_users, username) >= 0) {
        return;
      }
      selected_users.push(username);
      return update_user_selection();
    };
    update_user_selection = function() {
      var username, _i, _len, _results;
      dom_selected_list.empty();
      _results = [];
      for (_i = 0, _len = selected_users.length; _i < _len; _i++) {
        username = selected_users[_i];
        _results.push(dom_selected_list.append($("<li class='added_user'>" + username + "</li>")));
      }
      return _results;
    };
    create_suggestion_box = function(username) {
      var box_class;
      box_class = "non_added_user";
      if (__indexOf.call(selected_users, username) >= 0) {
        box_class = "added_user";
      }
      return $("<li class='" + box_class + "'><a>" + username + "</a></li>");
    };
    cache = {};
    dom_complete_box.bind("keydown", function(event) {
      if (event.keyCode === $.ui.keyCode.ENTER) {
        add_to_selected_users($(this).val());
        return event.preventDefault();
      }
    });
    dom_complete_box.autocomplete({
      source: function(request, response) {
        var partial_username;
        partial_username = request.term;
        if (partial_username in cache) {
          return response(cache[partial_username]);
        }
        return $.getJSON("/account/complete_users_and_groups/" + request.term, function(data, status, xhr) {
          cache[partial_username] = data;
          return response(data);
        });
      },
      minLength: 2,
      select: function(event, ui) {
        if (ui.item != null) {
          add_to_selected_users(ui.item.value);
          return event.preventDefault();
        } else {
          alert("Nothing selected, input was " + this.value);
          return event.preventDefault();
        }
      }
    });
    return dom_complete_box.data("ui-autocomplete")._renderItem = function(ul, item) {
      return create_suggestion_box(item.value).appendTo(ul);
    };
  });

}).call(this);
